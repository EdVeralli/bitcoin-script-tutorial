# Tutorial MultiSig Bitcoin con PRUNE Activado - VERSI√ìN FINAL CORREGIDA

**‚úÖ Tutorial Optimizado para Nodos Pruneados - Todos los Errores Solucionados**

Funciona perfectamente con: `prune=2000` (solo 2GB de blockchain)

> üîß **Versi√≥n Final**: Corregidos todos los errores de wallet, descriptors e importaci√≥n

## üìã Tabla de Contenidos

1. [Configuraci√≥n Inicial con PRUNE](#configuraci√≥n-inicial-con-prune)
2. [Limpieza y Preparaci√≥n](#limpieza-y-preparaci√≥n)
3. [Creaci√≥n del MultiSig](#creaci√≥n-del-multisig)
4. [Funding con Prune](#funding-con-prune)
5. [Gasto desde MultiSig con Prune](#gasto-desde-multisig-con-prune)
6. [Verificaci√≥n Final](#verificaci√≥n-final)
7. [Soluci√≥n de Problemas con Prune](#soluci√≥n-de-problemas-con-prune)
8. [Monitoreo con Prune](#monitoreo-con-prune)

## üìã Configuraci√≥n Inicial con PRUNE

### 1. Configurar bitcoin.conf para Prune

Crear/editar el archivo `~/.bitcoin/bitcoin.conf`:

```bash
# Archivo: ~/.bitcoin/bitcoin.conf
testnet=1
server=1
rpcuser=tu_usuario
rpcpassword=tu_password_segura
prune=2000                # ‚úÖ Solo 2GB de espacio
fallbackfee=0.00001       # ‚úÖ Crucial para testnet
maxconnections=40         # ‚úÖ Optimizar para prune
```

### 2. Iniciar Bitcoin Core con Prune

```bash
# Detener si est√° corriendo
bitcoin-cli -testnet stop 2>/dev/null; sleep 5

# Iniciar con prune
bitcoind -testnet -daemon -prune=2000 -fallbackfee=0.00001
echo "‚è≥ Iniciando nodo pruneado... (puede tardar 2-5 minutos en sincronizar)"

# Esperar inicializaci√≥n - M√ÅS TIEMPO por el prune
echo "‚è≥ Sincronizando con prune activado..."
sleep 60

# Verificar estado de sincronizaci√≥n
while true; do
    SYNC_STATUS=$(bitcoin-cli -testnet getblockchaininfo 2>/dev/null)
    if [ $? -eq 0 ]; then
        VERIFICATION_PROGRESS=$(echo "$SYNC_STATUS" | jq -r '.verificationprogress')
        BLOCKS=$(echo "$SYNC_STATUS" | jq -r '.blocks')
        PRUNED=$(echo "$SYNC_STATUS" | jq -r '.pruned')
        
        echo "üìä Bloques: $BLOCKS - Progreso: $(echo "scale=2; $VERIFICATION_PROGRESS*100" | bc)% - Pruneado: $PRUNED"
        
        if [ $(echo "$VERIFICATION_PROGRESS > 0.99" | bc -l) -eq 1 ]; then
            echo "‚úÖ Nodo sincronizado y listo"
            break
        fi
    else
        echo "‚è≥ Nodo a√∫n iniciando..."
    fi
    sleep 30
done

# Verificar estado pruneado espec√≠fico
bitcoin-cli -testnet getblockchaininfo | grep -E "(pruned|size_on_disk|verificationprogress)"
echo "üíæ Espacio usado: $(du -sh ~/.bitcoin/testnet3/ | cut -f1)"
```

## üßπ Limpieza y Preparaci√≥n

### Si Hay Problemas con Wallets Previos

```bash
# Detener Bitcoin Core
bitcoin-cli -testnet stop
sleep 10

# Verificar que se detuvo completamente
ps aux | grep bitcoind

# Limpiar wallets problem√°ticos
rm -rf ~/.bitcoin/testnet3/wallets/multisig_prune
rm -rf ~/.bitcoin/testnet3/wallets/multisig_tutorial
rm -rf ~/.bitcoin/testnet3/wallets/multisig_*

# Verificar que se eliminaron
ls -la ~/.bitcoin/testnet3/wallets/

# Reiniciar Bitcoin Core limpio
bitcoind -testnet -daemon -prune=2000 -fallbackfee=0.00001
echo "‚è≥ Iniciando Bitcoin Core limpio..."
sleep 60

# Verificar que est√° funcionando
bitcoin-cli -testnet getblockchaininfo | head -5
echo "‚úÖ Bitcoin Core reiniciado correctamente"
```

### Crear Wallet Nuevo y Funcional

```bash
# Verificar que no hay wallets cargados
bitcoin-cli -testnet listwallets

# Crear wallet nuevo con par√°metros corregidos para MultiSig
# Par√°metros: wallet_name, disable_private_keys, blank, passphrase, avoid_reuse, descriptors
bitcoin-cli -testnet createwallet "multisig_clean" false false "" false true

# El wallet se carga autom√°ticamente, verificar
bitcoin-cli -testnet listwallets

# Generar keypool inicial
bitcoin-cli -testnet keypoolrefill 100

# Verificar keypool
KEYPOOL_SIZE=$(bitcoin-cli -testnet getwalletinfo | jq -r '.keypoolsize')
echo "üìä Keypool size: $KEYPOOL_SIZE"

# Probar generaci√≥n de direcci√≥n
TEST_ADDR=$(bitcoin-cli -testnet getnewaddress "test" "bech32")
echo "üß™ Direcci√≥n de prueba: $TEST_ADDR"

if [ -n "$TEST_ADDR" ] && [ "$TEST_ADDR" != "null" ]; then
    echo "‚úÖ Wallet funcionando correctamente"
    echo "üí° Wallet creado con descriptors habilitados para MultiSig"
else
    echo "‚ùå Error en wallet - revisar configuraci√≥n"
    echo "üí° Intentar recrear wallet o verificar Bitcoin Core"
    return 1
fi
```

## üîê Creaci√≥n del MultiSig

### 1. Generar Claves

```bash
# Verificar que el wallet est√© funcionando
KEYPOOL_SIZE=$(bitcoin-cli -testnet getwalletinfo | jq -r '.keypoolsize')
echo "üìä Keypool size: $KEYPOOL_SIZE"

# Generar 3 direcciones SegWit con verificaci√≥n
echo "üîë Generando direcciones para MultiSig..."

ADDR1=$(bitcoin-cli -testnet getnewaddress "participante1" "bech32")
if [ -z "$ADDR1" ]; then
    echo "‚ùå Error generando ADDR1 - verificar wallet"
    return 1
fi

ADDR2=$(bitcoin-cli -testnet getnewaddress "participante2" "bech32")
if [ -z "$ADDR2" ]; then
    echo "‚ùå Error generando ADDR2 - verificar wallet"
    return 1
fi

ADDR3=$(bitcoin-cli -testnet getnewaddress "participante3" "bech32")
if [ -z "$ADDR3" ]; then
    echo "‚ùå Error generando ADDR3 - verificar wallet"
    return 1
fi

echo "‚úÖ Claves generadas exitosamente:"
echo "üîë Participante 1: $ADDR1"
echo "üîë Participante 2: $ADDR2"
echo "üîë Participante 3: $ADDR3"
```

### 2. Obtener Claves P√∫blicas

```bash
# Extraer claves p√∫blicas con verificaci√≥n
echo "üìã Extrayendo claves p√∫blicas..."

PUBKEY1=$(bitcoin-cli -testnet getaddressinfo "$ADDR1" | jq -r '.pubkey')
if [ -z "$PUBKEY1" ] || [ "$PUBKEY1" = "null" ]; then
    echo "‚ùå Error extrayendo PUBKEY1 - verificar direcci√≥n"
    return 1
fi

PUBKEY2=$(bitcoin-cli -testnet getaddressinfo "$ADDR2" | jq -r '.pubkey')
if [ -z "$PUBKEY2" ] || [ "$PUBKEY2" = "null" ]; then
    echo "‚ùå Error extrayendo PUBKEY2 - verificar direcci√≥n"
    return 1
fi

PUBKEY3=$(bitcoin-cli -testnet getaddressinfo "$ADDR3" | jq -r '.pubkey')
if [ -z "$PUBKEY3" ] || [ "$PUBKEY3" = "null" ]; then
    echo "‚ùå Error extrayendo PUBKEY3 - verificar direcci√≥n"
    return 1
fi

echo "‚úÖ Claves p√∫blicas extra√≠das:"
echo "üìã PubKey 1: $PUBKEY1"
echo "üìã PubKey 2: $PUBKEY2"
echo "üìã PubKey 3: $PUBKEY3"
```

### 3. Crear MultiSig

```bash
# Crear descriptor con checksum
echo "üßæ Creando descriptor MultiSig..."
DESCRIPTOR_INFO=$(bitcoin-cli -testnet getdescriptorinfo "wsh(multi(2,$PUBKEY1,$PUBKEY2,$PUBKEY3))")
DESCRIPTOR=$(echo $DESCRIPTOR_INFO | jq -r '.descriptor')
CHECKSUM=$(echo $DESCRIPTOR_INFO | jq -r '.checksum')

echo "üìã Descriptor: $DESCRIPTOR"
echo "üîç Checksum: $CHECKSUM"

# Crear direcci√≥n multisig
MULTISIG_INFO=$(bitcoin-cli -testnet createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" "bech32")
MULTISIG_ADDR=$(echo $MULTISIG_INFO | jq -r '.address')
REDEEM_SCRIPT=$(echo $MULTISIG_INFO | jq -r '.redeemScript')

echo "‚úÖ MultiSig creado:"
echo "üéØ Direcci√≥n MultiSig: $MULTISIG_ADDR"
echo "üìú Redeem Script: $REDEEM_SCRIPT"
```

### 4. Configurar MultiSig en el Wallet

```bash
# Intentar importar descriptor (puede fallar en wallets modernos con claves privadas)
echo "üì• Configurando MultiSig en el wallet..."
IMPORT_RESULT=$(bitcoin-cli -testnet importdescriptors "[{
  \"desc\": \"$DESCRIPTOR\",
  \"active\": false,
  \"internal\": false,
  \"timestamp\": \"now\"
}]" 2>/dev/null || echo "Import failed - using alternative method")

echo "üìã Resultado configuraci√≥n: $IMPORT_RESULT"

# Verificar estado del multisig
ADDR_INFO=$(bitcoin-cli -testnet getaddressinfo "$MULTISIG_ADDR")
IS_MINE=$(echo $ADDR_INFO | jq -r '.ismine')
IS_SOLVABLE=$(echo $ADDR_INFO | jq -r '.solvable')

echo "‚úÖ Estado MultiSig:"
echo "   - Is Mine: $IS_MINE"
echo "   - Is Solvable: $IS_SOLVABLE"

# El MultiSig funcionar√° aunque ismine=false porque tenemos las claves privadas
if [ "$IS_MINE" = "true" ] && [ "$IS_SOLVABLE" = "true" ]; then
    echo "‚úÖ MultiSig completamente integrado al wallet"
elif [ "$IS_SOLVABLE" = "true" ]; then
    echo "‚úÖ MultiSig funcional (solvable=true)"
else
    echo "‚ö†Ô∏è  MultiSig configurado - funcionar√° con claves privadas del wallet"
fi

echo ""
echo "üìã Informaci√≥n MultiSig guardada:"
echo "   üéØ Direcci√≥n: $MULTISIG_ADDR"
echo "   üìú Redeem Script: $REDEEM_SCRIPT"
echo "   üßæ Descriptor: $DESCRIPTOR"
echo ""
echo "üí° IMPORTANTE: Aunque 'ismine=false', el MultiSig funcionar√° correctamente"
echo "   porque las claves privadas est√°n en este wallet y tenemos el redeemScript"
```

## üí∞ Funding con Prune - Consideraciones Especiales

### 1. Obtener Fondos de Faucet

```bash
# Crear direcci√≥n para faucet
FAUCET_ADDR=$(bitcoin-cli -testnet getnewaddress "faucet" "bech32")
echo "üì® Env√≠a tBTC a esta direcci√≥n: $FAUCET_ADDR"
echo "üåê Usar faucet: https://coinfaucet.eu/en/btc-testnet/"
echo "üåê O tambi√©n: https://testnet-faucet.mempool.co/"

# Monitorear fondos (con prune puede ser m√°s lento)
echo "‚è≥ Esperando fondos... (con prune puede tardar m√°s en detectar transacciones)"
echo "üí° Presiona Ctrl+C cuando lleguen los fondos para continuar"

while true; do
    BALANCE=$(bitcoin-cli -testnet getbalance)
    UNCONFIRMED=$(bitcoin-cli -testnet getunconfirmedbalance)
    
    if [ $(echo "$BALANCE > 0" | bc -l) -eq 1 ]; then
        echo "‚úÖ Fondos confirmados: $BALANCE tBTC"
        break
    elif [ $(echo "$UNCONFIRMED > 0" | bc -l) -eq 1 ]; then
        echo "‚è≥ Fondos no confirmados: $UNCONFIRMED tBTC - Balance: $BALANCE tBTC"
    else
        echo "‚è≥ Balance: $BALANCE tBTC - Esperando fondos..."
    fi
    sleep 30
done
```

### 2. Enviar al MultiSig (con prune)

```bash
# Verificar balance disponible
CURRENT_BALANCE=$(bitcoin-cli -testnet getbalance)
echo "üí∞ Balance disponible: $CURRENT_BALANCE tBTC"

# Enviar al MultiSig - m√©todo simplificado que funciona mejor
SEND_AMOUNT=0.0005
echo "‚è≥ Enviando $SEND_AMOUNT tBTC al multisig..."

# Intentar env√≠o simple primero (suele funcionar mejor)
TXID_FUNDING=$(bitcoin-cli -testnet sendtoaddress $MULTISIG_ADDR $SEND_AMOUNT 2>/dev/null)

# Si falla el m√©todo simple, intentar con fee expl√≠cito
if [ -z "$TXID_FUNDING" ]; then
    echo "‚ö†Ô∏è  M√©todo simple fall√≥, intentando con fee expl√≠cito..."
    TXID_FUNDING=$(bitcoin-cli -testnet sendtoaddress "$MULTISIG_ADDR" $SEND_AMOUNT "" "" false true 0.00002 "economical" 2>/dev/null)
fi

# Si sigue fallando, usar fee m√°s alto
if [ -z "$TXID_FUNDING" ]; then
    echo "‚ö†Ô∏è  Reintentando con fee m√°s alto..."
    TXID_FUNDING=$(bitcoin-cli -testnet sendtoaddress "$MULTISIG_ADDR" $SEND_AMOUNT "" "" false true 0.00005 "economical" 2>/dev/null)
fi

# Verificar que la transacci√≥n se envi√≥
if [ -n "$TXID_FUNDING" ]; then
    echo "‚úÖ Transacci√≥n enviada exitosamente"
    echo "üì§ TXID de funding: $TXID_FUNDING"
    echo "üí∞ Amount enviado: $SEND_AMOUNT tBTC"
    echo "üéØ Destino: $MULTISIG_ADDR"
else
    echo "‚ùå Error: No se pudo enviar la transacci√≥n"
    echo "üí° Verificar balance y estado del nodo"
    echo "üí° Intentar manualmente o revisar configuraci√≥n"
    return 1
fi

# Monitorear confirmaci√≥n con prune (M√ÅS PACIENCIA)
echo "‚è≥ Esperando confirmaci√≥n (con prune puede tardar 20-40 minutos)..."
while true; do
    TX_INFO=$(bitcoin-cli -testnet gettransaction "$TXID_FUNDING" 2>/dev/null || echo "{}")
    CONFIRMATIONS=$(echo "$TX_INFO" | jq -r '.confirmations // 0')
    
    if [ "$CONFIRMATIONS" != "null" ] && [ "$CONFIRMATIONS" -ge 1 ]; then
        echo "‚úÖ Transacci√≥n confirmada ($CONFIRMATIONS confirmaciones)"
        break
    fi
    
    BLOCK_COUNT=$(bitcoin-cli -testnet getblockcount)
    echo "‚è≥ Confirmaciones: ${CONFIRMATIONS:-0} - Bloques actuales: $BLOCK_COUNT - Esperando 60 segundos..."
    sleep 60
done
```

### 3. Obtener UTXO con Prune

```bash
# Con prune, buscar UTXO puede requerir m√©todos adicionales
echo "‚è≥ Buscando UTXO multisig..."

# M√©todo 1: listunspent tradicional (puede fallar con MultiSig no importado)
UTXO_INFO=$(bitcoin-cli -testnet listunspent 1 999999 "[\"$MULTISIG_ADDR\"]" 2>/dev/null || echo "[]")

if [ "$(echo "$UTXO_INFO" | jq length)" -gt 0 ]; then
    echo "‚úÖ UTXO encontrado con listunspent"
    VOUT=$(echo "$UTXO_INFO" | jq -r '.[0].vout')
    AMOUNT=$(echo "$UTXO_INFO" | jq -r '.[0].amount')
    SCRIPT_PUB_KEY=$(echo "$UTXO_INFO" | jq -r '.[0].scriptPubKey')
else
    echo "‚ö†Ô∏è  listunspent no encontr√≥ UTXO, usando m√©todo alternativo..."
    
    # M√©todo 2: Usar gettxout directamente
    TX_OUT_INFO=$(bitcoin-cli -testnet gettxout "$TXID_FUNDING" 0 true 2>/dev/null || echo "null")
    if [ "$TX_OUT_INFO" != "null" ]; then
        VOUT=0
        AMOUNT=$(echo "$TX_OUT_INFO" | jq -r '.value')
        SCRIPT_PUB_KEY=$(echo "$TX_OUT_INFO" | jq -r '.scriptPubKey.hex')
        echo "‚úÖ UTXO encontrado con gettxout en vout 0"
    else
        # Intentar vout 1
        TX_OUT_INFO=$(bitcoin-cli -testnet gettxout "$TXID_FUNDING" 1 true 2>/dev/null || echo "null")
        if [ "$TX_OUT_INFO" != "null" ]; then
            VOUT=1
            AMOUNT=$(echo "$TX_OUT_INFO" | jq -r '.value')
            SCRIPT_PUB_KEY=$(echo "$TX_OUT_INFO" | jq -r '.scriptPubKey.hex')
            echo "‚úÖ UTXO encontrado con gettxout en vout 1"
        else
            echo "‚ùå No se pudo encontrar el UTXO"
            echo "üí° Verificar manualmente:"
            echo "   bitcoin-cli -testnet gettransaction $TXID_FUNDING"
            echo "üí° Continuar con valores manuales si es necesario"
            return 1
        fi
    fi
fi

echo "‚úÖ Informaci√≥n del UTXO:"
echo "   - TXID: $TXID_FUNDING"
echo "   - Vout: $VOUT"
echo "   - Amount: $AMOUNT"
echo "   - ScriptPubKey: $SCRIPT_PUB_KEY"

# Verificar que la direcci√≥n coincide
TX_DETAILS=$(bitcoin-cli -testnet gettransaction "$TXID_FUNDING")
ADDRESSES_IN_TX=$(echo "$TX_DETAILS" | jq -r '.details[].address' | grep "$MULTISIG_ADDR" || echo "")
if [ -n "$ADDRESSES_IN_TX" ]; then
    echo "‚úÖ Verificaci√≥n: MultiSig address encontrada en la transacci√≥n"
else
    echo "‚ö†Ô∏è  Advertencia: Verificar manualmente que el UTXO corresponde al MultiSig"
fi
```


------------------------------------------------------------------------------------------

# Corregir las variables manualmente
VOUT=1
AMOUNT=0.0005
SCRIPT_PUB_KEY="002015f306983756ccfcfee170d89887f81976b6df565b2c27e847f327dd006459fe"

echo "Variables corregidas para continuar con el tutorial:"
echo "   - VOUT: $VOUT"
echo "   - AMOUNT: $AMOUNT"
echo "   - SCRIPT_PUB_KEY: $SCRIPT_PUB_KEY"

-------------------------------------------------------------------------------------------




## üí∏ Gasto desde MultiSig con Prune

### 1. Preparar Transacci√≥n

```bash
# Crear direcci√≥n de destino
DESTINO=$(bitcoin-cli -testnet getnewaddress "destino" "bech32")
echo "üéØ Direcci√≥n destino: $DESTINO"

# Calcular amount a enviar (fee m√°s alto por prune)
FEE="0.00015"
SEND_AMOUNT=$(echo "scale=8; $AMOUNT - $FEE" | bc)

# Asegurar formato correcto para JSON (agregar 0 al inicio si empieza con punto)
if [[ $SEND_AMOUNT == .* ]]; then
    SEND_AMOUNT="0$SEND_AMOUNT"
fi

echo "üí∞ Amount disponible: $AMOUNT tBTC"
echo "üí∏ Fee: $FEE tBTC"
echo "üì§ Enviando: $SEND_AMOUNT tBTC"

# Crear transacci√≥n raw
RAW_TX=$(bitcoin-cli -testnet createrawtransaction "[{\"txid\":\"$TXID_FUNDING\",\"vout\":$VOUT}]" "{\"$DESTINO\":$SEND_AMOUNT}")
echo "üìÑ Transacci√≥n raw creada"
```

### 2. Firmar (Funciona igual con prune)

```bash
echo "‚úçÔ∏è  Firmando transacci√≥n MultiSig..."
SIGNED_TX=$(bitcoin-cli -testnet signrawtransactionwithwallet "$RAW_TX" "[{
  \"txid\":\"$TXID_FUNDING\",
  \"vout\":$VOUT,
  \"scriptPubKey\":\"$SCRIPT_PUB_KEY\",
  \"redeemScript\":\"$REDEEM_SCRIPT\",
  \"amount\":$AMOUNT
}]")

# Verificar firma completa
COMPLETE=$(echo $SIGNED_TX | jq -r '.complete')
if [ "$COMPLETE" = "true" ]; then
    HEX_TX=$(echo $SIGNED_TX | jq -r '.hex')
    echo "‚úÖ Transacci√≥n firmada exitosamente"
else
    echo "‚ùå Error en la firma:"
    echo "$SIGNED_TX" | jq -r '.errors'
    echo "üí° Verificar UTXO information y redeemScript"
    return 1
fi
```

### 3. Transmitir

```bash
# Transmitir a la red
FINAL_TXID=$(bitcoin-cli -testnet sendrawtransaction "$HEX_TX")
echo "üöÄ Transacci√≥n transmitida exitosamente"
echo "üìã TXID final: $FINAL_TXID"
echo "üîç Verificar en explorador: https://blockstream.info/testnet/tx/$FINAL_TXID"

# Esperar confirmaci√≥n con m√°s paciencia por prune
echo "‚è≥ Esperando confirmaci√≥n final (puede tardar 20-40 minutos con prune)..."
sleep 300

# Verificar estado de la transacci√≥n
TX_FINAL_INFO=$(bitcoin-cli -testnet gettransaction "$FINAL_TXID" 2>/dev/null || echo "{}")
FINAL_CONFIRMATIONS=$(echo "$TX_FINAL_INFO" | jq -r '.confirmations // 0')

echo "üìä Estado final: $FINAL_CONFIRMATIONS confirmaciones"
echo "$TX_FINAL_INFO" | jq '{confirmations, amount, fee}' 2>/dev/null || echo "Informaci√≥n pendiente..."
```

## üß™ Verificaci√≥n Final

```bash
echo "=== VERIFICACI√ìN FINAL COMPLETA ==="

# Verificar balance del wallet
FINAL_BALANCE=$(bitcoin-cli -testnet getbalance)
echo "üí∞ Balance final del wallet: $FINAL_BALANCE tBTC"

# Verificar que los fondos llegaron al destino
echo "üîç Verificando fondos en destino..."
UTXO_DESTINO=$(bitcoin-cli -testnet listunspent 0 999999 "[\"$DESTINO\"]")
if [ "$(echo $UTXO_DESTINO | jq length)" -gt 0 ]; then
    DESTINO_AMOUNT=$(echo $UTXO_DESTINO | jq -r '.[0].amount')
    echo "‚úÖ Fondos recibidos correctamente en destino"
    echo "üìä Amount en destino: $DESTINO_AMOUNT tBTC"
else
    echo "‚è≥ Fondos a√∫n no aparecen en destino (puede tardar con prune)"
fi

# Resumen completo de la ejecuci√≥n
echo ""
echo "=== RESUMEN COMPLETO ==="
echo "üéØ MultiSig Address: $MULTISIG_ADDR"
echo "üì§ TXID Funding: $TXID_FUNDING"
echo "üöÄ TXID Final: $FINAL_TXID"
echo "üè† Direcci√≥n Destino: $DESTINO"
echo "üí∞ Amount Enviado: $SEND_AMOUNT tBTC"
echo "üí∏ Fee Usado: $FEE tBTC"
echo "‚úÖ Tutorial MultiSig con Prune completado exitosamente"
```

## üîß Soluci√≥n de Problemas con Prune

### Error: "Fee estimation failed"

```bash
# Soluci√≥n: Usar fallback fee expl√≠cito m√°s alto
bitcoin-cli -testnet sendtoaddress "$DIRECCION" "$MONTO" "" "" false true 0.00005 "economical"
```

### Error: "Transaction not in memory pool"

```bash
# Con prune, las transacciones viejas no est√°n en mempool
# Soluci√≥n: Usar fees m√°s altos y esperar m√°s tiempo
bitcoin-cli -testnet sendtoaddress "$DIRECCION" "$MONTO" "" "" false true 0.0001 "economical"
```

### Error: "Cannot import descriptor without private keys"

```bash
# Este error es normal en wallets modernos con claves privadas habilitadas
# Soluci√≥n: El MultiSig funcionar√° sin importar el descriptor porque:
# 1. Las claves privadas est√°n en el wallet
# 2. Tenemos el redeemScript
# 3. signrawtransactionwithwallet reconocer√° las claves autom√°ticamente

echo "üí° No te preocupes por 'ismine=false' - el MultiSig funcionar√° correctamente"
```

### Error: "Only legacy wallets are supported by this command"

```bash
# Comando importaddress no funciona en wallets modernos
# Soluci√≥n: No es necesario - usar signrawtransactionwithwallet directamente
echo "üí° Los wallets modernos no necesitan importaddress para MultiSig"
```

### Error: "Insufficient funds" (con balance positivo)

```bash
# Con prune, a veces el wallet no ve UTXOs recientes
# Soluci√≥n: Rescan desde bloques recientes
CURRENT_BLOCK=$(bitcoin-cli -testnet getblockcount)
RESCAN_FROM=$((CURRENT_BLOCK - 100))
bitcoin-cli -testnet rescanblockchain $RESCAN_FROM
```

### Sincronizaci√≥n lenta

```bash
# Verificar estado de sincronizaci√≥n
watch -n 30 'bitcoin-cli -testnet getblockchaininfo | grep -E "(blocks|verificationprogress)"'

# Reiniciar conexiones de red
bitcoin-cli -testnet setnetworkactive false
sleep 5
bitcoin-cli -testnet setnetworkactive true
```

### El UTXO no aparece

```bash
# Verificar todas las direcciones del wallet
bitcoin-cli -testnet listunspent 0 999999

# Buscar transacciones espec√≠ficas
bitcoin-cli -testnet listtransactions "*" 10

# Verificar mempool
bitcoin-cli -testnet getrawmempool

# Si el UTXO del MultiSig no aparece, usar gettxout directamente
bitcoin-cli -testnet gettxout "$TXID_FUNDING" $VOUT true
```

## üìä Monitoreo con Prune

### Comandos √ötiles para Prune

```bash
# Estado del nodo pruneado
bitcoin-cli -testnet getblockchaininfo | grep -E "(pruned|size_on_disk|blocks)"

# Espacio usado en disco
du -sh ~/.bitcoin/testnet3/

# Estado del mempool (limitado con prune)
bitcoin-cli -testnet getmempoolinfo

# Conexiones de red
bitcoin-cli -testnet getnetworkinfo | grep connections

# Informaci√≥n del wallet
bitcoin-cli -testnet getwalletinfo | grep -E "(balance|txcount|keypoolsize)"
```

### Script de Monitoreo Completo

```bash
#!/bin/bash
# monitor_multisig_prune.sh

echo "üîÑ Iniciando monitoreo MultiSig con Prune..."

while true; do
    clear
    echo "=== MONITOR MULTISIG CON PRUNE ==="
    echo "‚è∞ $(date)"
    echo ""
    
    # Estado de la blockchain
    echo "üìä ESTADO BLOCKCHAIN:"
    bitcoin-cli -testnet getblockchaininfo | grep -E "(blocks|verificationprogress|pruned)" 2>/dev/null || echo "‚ùå Error conectando"
    echo ""
    
    # Estado del wallet
    echo "üí∞ ESTADO WALLET:"
    bitcoin-cli -testnet getwalletinfo | grep -E "(balance|txcount|keypoolsize)" 2>/dev/null || echo "‚ùå Wallet no disponible"
    echo ""
    
    # Uso de espacio
    echo "üíæ USO DE ESPACIO:"
    echo "   Testnet: $(du -sh ~/.bitcoin/testnet3/ 2>/dev/null | cut -f1 || echo 'N/A')"
    echo "   Total Bitcoin: $(du -sh ~/.bitcoin/ 2>/dev/null | cut -f1 || echo 'N/A')"
    echo ""
    
    # Conexiones de red
    echo "üåê RED:"
    CONNECTIONS=$(bitcoin-cli -testnet getnetworkinfo 2>/dev/null | jq -r '.connections' || echo "0")
    echo "   Conexiones: $CONNECTIONS"
    echo ""
    
    # Mempool
    echo "üì¶ MEMPOOL:"
    MEMPOOL_SIZE=$(bitcoin-cli -testnet getmempoolinfo 2>/dev/null | jq -r '.size' || echo "0")
    echo "   Transacciones: $MEMPOOL_SIZE"
    
    echo "========================"
    echo "üí° Presiona Ctrl+C para salir"
    
    sleep 30
done
```

## ‚úÖ Conclusi√≥n

### Ventajas del MultiSig con Prune

- **Espacio reducido**: Solo 2GB vs ~500GB del nodo completo
- **Funcionalidad completa**: Todas las operaciones MultiSig funcionan
- **Seguridad mantenida**: Misma seguridad que nodo completo
- **Ideal para testing**: Perfecto para desarrollo y pruebas

### Consideraciones Importantes

- **M√°s paciencia**: Confirmaciones pueden tardar m√°s
- **Fees m√°s altos**: Recomendado usar fees ligeramente superiores
- **Monitoreo activo**: Verificar estado m√°s frecuentemente
- **Rescans ocasionales**: Pueden ser necesarios para UTXOs

### Pr√≥ximos Pasos para Producci√≥n

1. **Migrar a mainnet**: Cambiar configuraci√≥n a red principal
2. **Hardware wallets**: Usar dispositivos especializados
3. **PSBTs**: Implementar Partially Signed Bitcoin Transactions
4. **Backups seguros**: Guardar descriptors y claves en lugar seguro
5. **Testing exhaustivo**: Probar todos los escenarios posibles

---

> üéØ **Resultado**: MultiSig 2-of-3 funcionando perfectamente en nodo Bitcoin pruneado con solo 2GB de almacenamiento